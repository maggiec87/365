<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>365æ‰“å¡</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* é»˜è®¤å˜é‡ï¼Œä¼šè¢«JSåŠ¨æ€æ›¿æ¢ */
            --primary: #FF9A9E; 
            --primary-gradient: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            --bg: #FFF9F2;
            --card: #ffffff;
            --text: #555;
            --text-light: #999;
        }

        body {
            font-family: "Nunito", "Muli", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 120px; /* å¢åŠ åº•éƒ¨ç•™ç™½ç»™å¿ƒæƒ…æ¡† */
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease;
        }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 20px 20px 45px 20px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            position: relative;
            z-index: 10;
            transition: background 0.5s ease;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        /* æ¢è‚¤æŒ‰é’® */
        .theme-btn {
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: transform 0.2s;
        }
        .theme-btn:active { transform: scale(0.9); }

        /* æ—¥æœŸä¸å¤©æ°”åŒºåŸŸ */
        .date-weather-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
        }
        .date-picker {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.5);
            color: #fff;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: bold;
            outline: none;
            backdrop-filter: blur(5px);
            font-size: 0.9rem;
        }
        .weekday-badge {
            background: rgba(255,255,255,0.3);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .weather-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
        }

        /* æ‚¬æµ®ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background: white;
            margin: -35px 20px 20px 20px;
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            position: relative;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .stats-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; }
        .points-badge { 
            background: #fff8e1; color: #f6b93b; 
            border: 1px solid #ffeaa7;
            padding: 4px 12px; border-radius: 12px; font-weight: bold; 
        }

        .progress-bar-bg {
            height: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 10px;
        }

        .container { padding: 10px 20px; max-width: 600px; margin: 0 auto; }

        /* åˆ†ç±»å¡ç‰‡ */
        .category-card {
            background: var(--card);
            border-radius: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            overflow: hidden;
            transition: transform 0.2s;
        }
        .category-card:active { transform: scale(0.99); }

        .category-header {
            padding: 15px 20px;
            font-weight: 800;
            font-size: 1.1rem;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.5);
        }
        .cat-indicator {
            width: 6px; height: 18px; border-radius: 3px; 
            margin-right: 10px; display: inline-block; vertical-align: middle;
        }

        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item {
            padding: 15px 20px;
            border-top: 1px solid #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }
        .task-item:hover { background: #fcfcfc; }
        .task-left { display: flex; align-items: center; flex: 1; }
        
        .icon-box {
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-right: 12px;
            font-size: 16px;
            color: white;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .custom-checkbox {
            width: 24px; height: 24px;
            border: 2px solid #ddd;
            border-radius: 50%;
            margin-right: 15px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex-shrink: 0;
        }
        .custom-checkbox.checked {
            background: var(--primary); /* è·Ÿéšä¸»é¢˜è‰² */
            border-color: var(--primary);
            transform: scale(1.1);
        }
        .custom-checkbox.checked::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: white;
            font-size: 14px;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }

        .task-info { display: flex; flex-direction: column; }
        .task-name { font-size: 1rem; font-weight: 600; color: #444; }
        .task-meta { font-size: 0.75rem; color: #aaa; margin-top: 4px; font-weight: 500; }
        .completed-text .task-name { text-decoration: line-through; color: #ccc; }
        .completed-text .icon-box { filter: grayscale(100%); opacity: 0.5; }

        .btn-icon { 
            border: none; background: #f0f2f5; color: #888; 
            width: 30px; height: 30px; border-radius: 50%; 
            cursor: pointer; margin-left: 5px; 
            display: flex; align-items: center; justify-content: center;
        }

        /* å¿ƒæƒ…æ—¥è®°åŒºåŸŸ */
        .emotion-section {
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .emotion-title { font-size: 0.9rem; color: #888; margin-bottom: 8px; font-weight: bold; }
        .emotion-input {
            width: 100%;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 10px;
            font-family: inherit;
            resize: none;
            box-sizing: border-box;
            background: #fcfcfc;
            color: #555;
            outline: none;
            transition: border 0.3s;
        }
        .emotion-input:focus { border-color: var(--primary); background: white; }

        /* åº•éƒ¨æ  */
        .bottom-bar {
            position: fixed;
            bottom: 20px; left: 20px; right: 20px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .btn-main {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            flex: 1;
            margin-left: 15px;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.95); }
        .btn-ghost {
            background: transparent; border: 1px solid #eee; color: #888;
            padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 200; backdrop-filter: blur(2px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 24px; width: 80%; max-width: 360px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .form-control {
            width: 100%; padding: 12px; margin-top: 5px;
            border: 2px solid #f0f0f0; border-radius: 12px;
            box-sizing: border-box; font-size: 1rem; transition: border-color 0.3s;
        }
        .form-control:focus { border-color: var(--primary); outline: none; }
        
        .icon-select { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; justify-content: center; }
        .icon-option { 
            width: 36px; height: 36px; border-radius: 50%; background: #f0f0f0; color: #888;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.2s;
        }
        .icon-option.selected { background: var(--primary); color: white; transform: scale(1.1); }

        /* é¢œè‰²é€‰æ‹©ç½‘æ ¼ */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .theme-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
        }
        .theme-dot {
            width: 40px; height: 40px; border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            margin-bottom: 5px;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .theme-item:hover .theme-dot { transform: scale(1.1); }
        .theme-name { font-size: 0.75rem; color: #888; }

    </style>
</head>
<body>

<div class="header">
    <div class="header-top">
        <!-- æ¢è‚¤æŒ‰é’® -->
        <button class="theme-btn" onclick="openThemeModal()">
            <i class="fas fa-tshirt"></i>
        </button>
        <h3 style="margin:0; font-size: 1.2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">365æ‰“å¡</h3>
        <div style="width:36px"></div> <!-- å ä½ç¬¦ä¿æŒå±…ä¸­ -->
    </div>
    
    <!-- æ—¥æœŸä¸å¤©æ°”è¡Œ -->
    <div class="date-weather-row">
        <input type="date" id="datePicker" class="date-picker">
        <span id="weekdayDisplay" class="weekday-badge">å‘¨ä¸€</span>
        <button id="weatherBtn" class="weather-btn" onclick="toggleWeather()">â˜€ï¸</button>
    </div>
</div>

<div class="stats-card">
    <div class="stats-row">
        <span style="color:#888">ä»Šæ—¥é‡‘å¸</span>
        <span class="points-badge">ğŸ’° <span id="todayPoints">0</span></span>
    </div>
    <div class="stats-row" style="margin-top:5px;">
        <span style="font-size:0.8rem; color:#aaa">å®Œæˆåº¦ <span id="todayPercent">0%</span></span>
    </div>
    <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progressBar"></div>
    </div>
</div>

<div class="container" id="appContainer">
    <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ -->
</div>

<div class="container">
    <!-- å¿ƒæƒ…æ—¥è®° -->
    <div class="emotion-section">
        <div class="emotion-title">ğŸ“ ä»Šæ—¥æ„Ÿæƒ³ </div>
        <textarea id="emotionInput" class="emotion-input" rows="2" placeholder="ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿå†™ä¸‹æ¥å§..."></textarea>
    </div>

    <div style="text-align: center; margin: 20px 0 50px 0;">
        <button class="btn-ghost" onclick="showAddCategoryModal()">+ æ–°ç±»åˆ«</button>
        <button class="btn-ghost" onclick="exportData()" style="margin-left: 10px;">ğŸ’¾ å¤‡ä»½</button>
    </div>
</div>

<div class="bottom-bar">
    <span id="statusMsg" style="font-size: 0.75rem; color: #aaa;">âœ¨ ç§¯æ”’é‡‘å¸ï¼Œå…‘æ¢å¿«ä¹</span>
    <button class="btn-main" onclick="saveData(true)">ä¿å­˜è¿›åº¦</button>
</div>

<!-- ä»»åŠ¡æ¨¡æ€æ¡† -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-top:0; color:#444;">æ·»åŠ ä»»åŠ¡</h3>
        <input type="hidden" id="modalCatId">
        <input type="hidden" id="modalTaskId">
        
        <div style="margin-bottom:15px">
            <label style="font-size:0.9rem;color:#888;font-weight:bold">ä»»åŠ¡åç§°</label>
            <input type="text" id="taskNameInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šåšç‘œä¼½">
        </div>
        
        <div style="margin-bottom:15px">
            <label style="font-size:0.9rem;color:#888;font-weight:bold">å¥–åŠ±é‡‘å¸ (ğŸ’°)</label>
            <input type="number" id="taskPointsInput" class="form-control" value="10">
        </div>

        <div style="margin-bottom:20px">
            <label style="font-size:0.9rem;color:#888;font-weight:bold">é€‰æ‹©å›¾æ ‡</label>
            <div class="icon-select" id="iconSelector"></div>
            <input type="text" id="customIconInput" class="form-control" placeholder="æˆ– FontAwesome ç±»å" style="margin-top:10px; font-size:0.8rem;">
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-ghost" onclick="closeModal('taskModal')">å–æ¶ˆ</button>
            <button class="btn-main" style="margin:0; flex:none; padding: 10px 25px;" onclick="confirmSaveTask()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- ç±»åˆ«æ¨¡æ€æ¡† -->
<div id="catModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:#444;">æ–°å¢ç±»åˆ«</h3>
        <div style="margin-bottom:15px">
            <label style="font-size:0.9rem;color:#888;font-weight:bold">ç±»åˆ«åç§°</label>
            <input type="text" id="catNameInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šè¿åŠ¨">
        </div>
        <div style="margin-bottom:20px">
            <label style="font-size:0.9rem;color:#888;font-weight:bold">ä¸»é¢˜è‰² (Hex)</label>
            <input type="text" id="catColorInput" class="form-control" value="#ff9a9e">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn-ghost" onclick="closeModal('catModal')">å–æ¶ˆ</button>
            <button class="btn-main" style="margin:0; flex:none; padding: 10px 25px;" onclick="confirmAddCategory()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- æ¢è‚¤æ¨¡æ€æ¡† -->
<div id="themeModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <h3 style="margin-top:0; color:#444;">é€‰æ‹©çš®è‚¤</h3>
        <p style="font-size:0.8rem; color:#aaa; margin-bottom:15px;">ç‚¹å‡»é¢œè‰²å³å¯åˆ‡æ¢</p>
        
        <div class="theme-grid">
            <div class="theme-item" onclick="switchTheme('pink')">
                <div class="theme-dot" style="background: #FF9A9E;"></div>
                <span class="theme-name">è‰è“ç‰›å¥¶</span>
            </div>
            <div class="theme-item" onclick="switchTheme('blue')">
                <div class="theme-dot" style="background: #a1c4fd;"></div>
                <span class="theme-name">æµ·ç›è“</span>
            </div>
            <div class="theme-item" onclick="switchTheme('green')">
                <div class="theme-dot" style="background: #84fab0;"></div>
                <span class="theme-name">è–„è·ç»¿</span>
            </div>
            <div class="theme-item" onclick="switchTheme('purple')">
                <div class="theme-dot" style="background: #a18cd1;"></div>
                <span class="theme-name">é¦™èŠ‹ç´«</span>
            </div>
            <div class="theme-item" onclick="switchTheme('yellow')">
                <div class="theme-dot" style="background: #fccb90;"></div>
                <span class="theme-name">æŸ æª¬é»„</span>
            </div>
        </div>

        <button class="btn-ghost" onclick="closeModal('themeModal')" style="margin-top:20px; width:100%">å…³é—­</button>
    </div>
</div>

<script>
    // --- 1. é…è‰²æ–¹æ¡ˆé…ç½® ---
    const themes = {
        pink: {
            primary: '#FF9A9E',
            gradient: 'linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%)',
            bg: '#FFF9F2'
        },
        blue: {
            primary: '#a1c4fd',
            gradient: 'linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)',
            bg: '#f0f8ff'
        },
        green: {
            primary: '#84fab0',
            gradient: 'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)',
            bg: '#f0fff4'
        },
        purple: {
            primary: '#a18cd1',
            gradient: 'linear-gradient(120deg, #a18cd1 0%, #fbc2eb 100%)',
            bg: '#fdfaff'
        },
        yellow: {
            primary: '#fccb90',
            gradient: 'linear-gradient(120deg, #f6d365 0%, #fda085 100%)',
            bg: '#fffdf0'
        }
    };

    // --- 2. æ•°æ®ç»“æ„ ---
    const defaultData = {
        categories: [
            {
                id: 'cat_health', name: 'å¥åº·', color: '#84fab0', 
                tasks: [
                    { id: 't_run', name: 'æ™¨è·‘3å…¬é‡Œ', icon: 'fa-person-running', points: 20 },
                    { id: 't_water', name: 'å–æ°´8æ¯', icon: 'fa-glass-water', points: 5 },
                    { id: 't_fruit', name: 'åƒæ°´æœ', icon: 'fa-carrot', points: 10 }
                ]
            },
            {
                id: 'cat_study', name: 'å­¦ä¹ ', color: '#a18cd1',
                tasks: [
                    { id: 't_read', name: 'é˜…è¯»30åˆ†é’Ÿ', icon: 'fa-book-open', points: 15 },
                    { id: 't_word', name: 'èƒŒå•è¯', icon: 'fa-language', points: 10 }
                ]
            },
            {
                id: 'cat_ent', name: 'å¿«ä¹', color: '#ff9a9e',
                tasks: [
                    { id: 't_game', name: 'æ¸¸æˆæ—¶é—´', icon: 'fa-gamepad', points: 5 },
                    { id: 't_movie', name: 'è¿½å‰§/ç”µå½±', icon: 'fa-film', points: 10 }
                ]
            },
            {
                id: 'cat_family', name: 'å®¶åº­', color: '#fccb90',
                tasks: [
                    { id: 't_clean', name: 'æ•´ç†æˆ¿é—´', icon: 'fa-broom', points: 15 },
                    { id: 't_cook', name: 'åšä¸€é¡¿é¥­', icon: 'fa-utensils', points: 20 }
                ]
            }
        ],
        records: {},
        dailyInfo: {} // æ–°å¢ï¼šå­˜å‚¨æ¯å¤©çš„å¤©æ°”å’Œå¿ƒæƒ…
    };

    let appData = JSON.parse(localStorage.getItem('pwa_365_data')) || defaultData;
    const datePicker = document.getElementById('datePicker');
    datePicker.valueAsDate = new Date();
    const commonIcons = ['fa-star', 'fa-heart', 'fa-music', 'fa-book', 'fa-cat', 'fa-dog', 'fa-lemon', 'fa-mug-hot', 'fa-bicycle', 'fa-camera', 'fa-ghost', 'fa-gift'];
    
    // å¤©æ°”é€‰é¡¹
    const weatherOptions = ['â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'â„ï¸', 'ğŸŒªï¸'];

    // --- 3. æ ¸å¿ƒé€»è¾‘ ---

    function init() {
        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        const savedTheme = localStorage.getItem('pwa_theme_choice') || 'pink';
        switchTheme(savedTheme);

        renderApp();
        renderIcons();
        updateDateInfo(); // åˆå§‹åŒ–æ—¥æœŸå’Œæ˜ŸæœŸ
        datePicker.addEventListener('change', () => {
            updateDateInfo();
            renderApp();
        });
    }

    function switchTheme(themeName) {
        const t = themes[themeName];
        if (!t) return;
        
        const root = document.documentElement;
        root.style.setProperty('--primary', t.primary);
        root.style.setProperty('--primary-gradient', t.gradient);
        root.style.setProperty('--bg', t.bg);
        
        localStorage.setItem('pwa_theme_choice', themeName);
        closeModal('themeModal');
    }

    function getSelectedDate() { return datePicker.value; }

    function updateDateInfo() {
        const dateStr = getSelectedDate();
        const dateObj = new Date(dateStr);
        const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        document.getElementById('weekdayDisplay').innerText = days[dateObj.getDay()];
    }

    // åˆ‡æ¢å¤©æ°”
    function toggleWeather() {
        const dateKey = getSelectedDate();
        if (!appData.dailyInfo) appData.dailyInfo = {};
        if (!appData.dailyInfo[dateKey]) appData.dailyInfo[dateKey] = {};

        let current = appData.dailyInfo[dateKey].weather || 'â˜€ï¸';
        let idx = weatherOptions.indexOf(current);
        let nextIdx = (idx + 1) % weatherOptions.length;
        let nextWeather = weatherOptions[nextIdx];

        appData.dailyInfo[dateKey].weather = nextWeather;
        document.getElementById('weatherBtn').innerText = nextWeather;
        saveData(false);
    }

    function renderApp() {
        const container = document.getElementById('appContainer');
        container.innerHTML = '';
        const dateKey = getSelectedDate();
        const dayRecords = appData.records[dateKey] || {};
        
        // æ¸²æŸ“å¤©æ°”å’Œå¿ƒæƒ…
        if (!appData.dailyInfo) appData.dailyInfo = {};
        const dayInfo = appData.dailyInfo[dateKey] || {};
        document.getElementById('weatherBtn').innerText = dayInfo.weather || 'â˜€ï¸';
        document.getElementById('emotionInput').value = dayInfo.emotion || '';

        let totalPoints = 0;
        let earnedPoints = 0;
        let totalTasks = 0;
        let completedTasks = 0;

        appData.categories.forEach(cat => {
            const catDiv = document.createElement('div');
            catDiv.className = 'category-card';
            
            let tasksHtml = '';
            cat.tasks.forEach(task => {
                const isChecked = dayRecords[task.id] === true;
                
                totalTasks++;
                totalPoints += parseInt(task.points);
                if (isChecked) {
                    completedTasks++;
                    earnedPoints += parseInt(task.points);
                }

                const iconStyle = `background: ${cat.color}`;

                tasksHtml += `
                    <li class="task-item">
                        <div class="task-left" onclick="toggleTask('${task.id}', ${!isChecked})">
                            <div class="custom-checkbox ${isChecked ? 'checked' : ''}"></div>
                            <div class="icon-box" style="${iconStyle}">
                                <i class="fas ${task.icon}"></i>
                            </div>
                            <div class="task-info ${isChecked ? 'completed-text' : ''}">
                                <span class="task-name">${task.name}</span>
                                <span class="task-meta">ğŸ’° +${task.points} é‡‘å¸</span>
                            </div>
                        </div>
                        <div class="task-actions">
                            <button class="btn-icon" onclick="event.stopPropagation(); openEditTask('${cat.id}', '${task.id}')"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon" onclick="event.stopPropagation(); deleteTask('${cat.id}', '${task.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>
                `;
            });

            catDiv.innerHTML = `
                <div class="category-header">
                    <div>
                        <span class="cat-indicator" style="background:${cat.color}"></span>
                        <span>${cat.name}</span>
                    </div>
                    <button class="btn-icon" onclick="openAddTask('${cat.id}')"><i class="fas fa-plus"></i></button>
                </div>
                <ul class="task-list">${tasksHtml}</ul>
            `;
            container.appendChild(catDiv);
        });

        animateValue("todayPoints", parseInt(document.getElementById('todayPoints').innerText), earnedPoints, 500);
        
        const percent = totalTasks === 0 ? 0 : Math.round((completedTasks / totalTasks) * 100);
        document.getElementById('todayPercent').innerText = percent + '%';
        document.getElementById('progressBar').style.width = percent + '%';
    }

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const range = end - start;
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        const obj = document.getElementById(id);
        const timer = setInterval(function() {
            current += increment;
            obj.innerHTML = current;
            if (current == end) { clearInterval(timer); }
        }, Math.max(stepTime, 10));
    }

    function toggleTask(taskId, isChecked) {
        const dateKey = getSelectedDate();
        if (!appData.records[dateKey]) {
            appData.records[dateKey] = {};
        }
        appData.records[dateKey][taskId] = isChecked;
        renderApp();
        document.getElementById('statusMsg').innerText = 'ğŸ“ è®°å¾—ç‚¹ä¿å­˜å“¦~';
    }

    function saveData(showAlert = false) {
        // ä¿å­˜å¿ƒæƒ…
        const dateKey = getSelectedDate();
        const emotion = document.getElementById('emotionInput').value;
        if (!appData.dailyInfo) appData.dailyInfo = {};
        if (!appData.dailyInfo[dateKey]) appData.dailyInfo[dateKey] = {};
        appData.dailyInfo[dateKey].emotion = emotion;
        // å¤©æ°”åœ¨åˆ‡æ¢æ—¶å·²ç»ä¿å­˜äº†

        localStorage.setItem('pwa_365_data', JSON.stringify(appData));
        document.getElementById('statusMsg').innerText = 'âœ… è¿›åº¦å·²ä¿å­˜';
        if(showAlert) alert('ä¿å­˜æˆåŠŸï¼æ˜å¤©ä¹Ÿè¦ç»§ç»­åŠ æ²¹é¸­ï¼');
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "365_habit_backup_" + getSelectedDate() + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // --- 4. æ¨¡æ€æ¡†é€»è¾‘ ---

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openThemeModal() { document.getElementById('themeModal').style.display = 'flex'; }

    function renderIcons() {
        const container = document.getElementById('iconSelector');
        container.innerHTML = commonIcons.map(icon => 
            `<div class="icon-option" onclick="selectIcon(this, '${icon}')"><i class="fas ${icon}"></i></div>`
        ).join('');
    }

    function selectIcon(el, iconClass) {
        document.querySelectorAll('.icon-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('customIconInput').value = iconClass;
    }

    function openAddTask(catId) {
        document.getElementById('modalTitle').innerText = 'æ·»åŠ æ–°æŒ‘æˆ˜';
        document.getElementById('modalCatId').value = catId;
        document.getElementById('modalTaskId').value = ''; 
        document.getElementById('taskNameInput').value = '';
        document.getElementById('taskPointsInput').value = '10';
        document.getElementById('customIconInput').value = 'fa-star';
        document.getElementById('taskModal').style.display = 'flex';
    }

    function openEditTask(catId, taskId) {
        const cat = appData.categories.find(c => c.id === catId);
        const task = cat.tasks.find(t => t.id === taskId);
        
        document.getElementById('modalTitle').innerText = 'ä¿®æ”¹ä»»åŠ¡';
        document.getElementById('modalCatId').value = catId;
        document.getElementById('modalTaskId').value = taskId;
        document.getElementById('taskNameInput').value = task.name;
        document.getElementById('taskPointsInput').value = task.points;
        document.getElementById('customIconInput').value = task.icon;
        document.getElementById('taskModal').style.display = 'flex';
    }

    function confirmSaveTask() {
        const catId = document.getElementById('modalCatId').value;
        const taskId = document.getElementById('modalTaskId').value;
        const name = document.getElementById('taskNameInput').value;
        const points = document.getElementById('taskPointsInput').value;
        const icon = document.getElementById('customIconInput').value || 'fa-star';

        if (!name) return alert('è¯·ç»™ä»»åŠ¡èµ·ä¸ªåå­—å§~');

        const catIndex = appData.categories.findIndex(c => c.id === catId);
        if (catIndex === -1) return;

        if (taskId) {
            const taskIndex = appData.categories[catIndex].tasks.findIndex(t => t.id === taskId);
            appData.categories[catIndex].tasks[taskIndex] = { id: taskId, name, points, icon };
        } else {
            const newId = 't_' + Date.now();
            appData.categories[catIndex].tasks.push({ id: newId, name, points, icon });
        }

        saveData(false);
        closeModal('taskModal');
        renderApp();
    }

    function deleteTask(catId, taskId) {
        if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
        const catIndex = appData.categories.findIndex(c => c.id === catId);
        appData.categories[catIndex].tasks = appData.categories[catIndex].tasks.filter(t => t.id !== taskId);
        saveData(false);
        renderApp();
    }

    function showAddCategoryModal() {
        document.getElementById('catNameInput').value = '';
        document.getElementById('catModal').style.display = 'flex';
    }

    function confirmAddCategory() {
        const name = document.getElementById('catNameInput').value;
        const color = document.getElementById('catColorInput').value || '#ff9a9e';
        if (!name) return alert('è¯·è¾“å…¥ç±»åˆ«åç§°');

        appData.categories.push({
            id: 'cat_' + Date.now(),
            name: name,
            color: color,
            tasks: []
        });
        saveData(false);
        closeModal('catModal');
        renderApp();
    }

    init();

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(err => console.log('SW failed', err));
    }
</script>
</body>
</html>
